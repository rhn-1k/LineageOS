name: Ultimate Infinity-X Builder

on:
  workflow_dispatch:
    inputs:
      crave_username:
        description: 'Your Crave.io Username'
        required: true
      crave_token:
        description: 'Your Crave.io Token (WARNING: may be visible in logs)'
        required: true
      device_codename:
        description: 'Device codename. For our semi-port, leave as gsi_arm64_ab.'
        required: true
        default: 'gsi_arm64_ab'
      maintainer_name:
        description: 'Your name to be shown as the maintainer'
        required: false
        default: 'Anonymous'
      include_gapps:
        description: 'Include Google Apps in the build?'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      has_udfps:
        description: 'Does the target device have an Under-Display Fingerprint Sensor?'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      # --- خصائص "حول الهاتف" (اختيارية) ---
      market_name:
        description: 'About Phone: Market Name (e.g., OnePlus 12R 5G)'
        required: false
      soc_name:
        description: 'About Phone: SoC (e.g., Snapdragon 8 Gen 2)'
        required: false
      battery_info:
        description: 'About Phone: Battery (e.g., 5500 mAh)'
        required: false
      display_info:
        description: 'About Phone: Display (e.g., 1264x2780, 120 Hz)'
        required: false
      camera_info:
        description: 'About Phone: Camera (e.g., 50MP + 8MP + 2MP)'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Crave Build
        uses: crave-cloud/crave-action@v1
        with:
          username: ${{ github.event.inputs.crave_username }}
          token: ${{ github.event.inputs.crave_token }}
          script: |
            #!/bin/bash
            set -e

            # ==================================================================
            #            إعداد متغيرات البناء
            # ==================================================================
            export INFINITY_BUILD_TYPE="UNOFFICIAL"
            export INFINITY_MAINTAINER="${{ github.event.inputs.maintainer_name }}"
            export TARGET_HAS_UDFPS="${{ github.event.inputs.has_udfps }}"
            export WITH_GAPPS="${{ github.event.inputs.include_gapps }}"
            export BUILD_VARIANT="userdebug"
            export DEVICE_CODENAME="${{ github.event.inputs.device_codename }}"

            # ==================================================================
            #                       بدء عملية البناء
            # ==================================================================
            echo "--- Initializing & Syncing Source ---"
            repo init --depth=1 --no-repo-verify --git-lfs -u https://github.com/ProjectInfinity-X/manifest -b 16 -g default,-mips,-darwin,-notdefault
            repo sync -c --no-clone-bundle --no-tags --optimized-fetch --prune --force-sync -j$(nproc --all)

            # ==================================================================
            #            إنشاء ملف خصائص النظام الإضافية (تم تصحيحه)
            # ==================================================================
            # سيتم إنشاء الملف دائماً طالما تم إدخال أي قيمة
            # المكان الصحيح لوضع الخصائص الإضافية في بناء GSI هو treble_adapter
            PROPS_FILE="treble_adapter/system.prop"
            echo "--- Creating custom system properties ---"
            echo "# Custom properties generated by build workflow" > ${PROPS_FILE}
            [ -n "${{ github.event.inputs.market_name }}" ] && echo "ro.product.marketname=${{ github.event.inputs.market_name }}" >> ${PROPS_FILE}
            [ -n "${{ github.event.inputs.soc_name }}" ] && echo "ro.infinity.soc=${{ github.event.inputs.soc_name }}" >> ${PROPS_FILE}
            [ -n "${{ github.event.inputs.battery_info }}" ] && echo "ro.infinity.battery=${{ github.event.inputs.battery_info }}" >> ${PROPS_FILE}
            [ -n "${{ github.event.inputs.display_info }}" ] && echo "ro.infinity.display=${{ github.event.inputs.display_info }}" >> ${PROPS_FILE}
            [ -n "${{ github.event.inputs.camera_info }}" ] && echo "ro.infinity.camera=${{ github.event.inputs.camera_info }}" >> ${PROPS_FILE}
            echo "Custom properties written to ${PROPS_FILE}"

            echo "--- Cloning & Applying Patches ---"
            git clone https://github.com/Doze-off/patches.git -b patches-15 patches
            bash patches/apply-patches.sh $(pwd) || true
            
            echo "--- Starting Compilation ---"
            source build/envsetup.sh
            lunch infinity_${DEVICE_CODENAME}-${BUILD_VARIANT}
            m bacon -j$(nproc --all)

            # ==================================================================
            #            رفع الروم إلى GoFile
            # ==================================================================
            echo "--- Uploading ROM to GoFile ---"
            ROM_PATH=$(find out/target/product/${DEVICE_CODENAME}/ -name "*.zip" | head -n 1)
            if [ -z "$ROM_PATH" ]; then echo "!!! ERROR: ROM file not found!"; exit 1; fi
            echo "Found ROM at: ${ROM_PATH}"
            SERVER=$(curl -s https://api.gofile.io/getServer | jq -r '.data.server')
            echo "Using GoFile server: ${SERVER}"
            UPLOAD_RESPONSE=$(curl -F "file=@${ROM_PATH}" -F "token=E29ro0ueg1dXX7CHmJSdrO9puOTUMREk" https://${SERVER}.gofile.io/uploadFile)
            echo "--- GoFile Upload Response ---"
            echo "${UPLOAD_RESPONSE}"
            DOWNLOAD_LINK=$(echo "${UPLOAD_RESPONSE}" | jq -r '.data.downloadPage')
            echo "======================================="
            echo "         !!! BUILD FINISHED !!!"
            echo "======================================="
            echo "Your download link is: ${DOWNLOAD_LINK}"
            echo "======================================="
